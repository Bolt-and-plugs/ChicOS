#include "render.h"
#include "../../chicos.h"
#include "../memory/mem.h"
#include <unistd.h>

extern App app;
volatile sig_atomic_t resized = 0;

void handle_resize(int sig) {
    resized = 1;
}

void print_logo(WINDOW *win) {
    wclear(win);
    box(win, 0, 0);
    wprintw(win, "::::::::::::::::::::::..................................................................................................\n");
    wprintw(win, "::::::::::::::.......................................::--=--::.:-......::----::.........................................\n");
    wprintw(win, ":::::::::::..........................:-==++*+:....-*%@@%#####%%@+...=*%%@%###%%%#+-...-=-:.........--:..................\n");
    wprintw(win, "::::::::...................--==+*#=..:-=@@@@= ...*@@@#:..   .:=+  :#@@@#:.....:+@@@#:.:::......:::::=+#*+=::............\n");
    wprintw(win, "::::::.............:-=+:...--*@@@@=...  =@@@@+. :#@@@#.        -= .#@@@#.      :%@@@+........:...:-==++#@@@%*+=-:.......\n");
    wprintw(win, ":::............:++#@@@%:.....:+@@@@#=....=%@@@-   -*%@@#*+++*#%@%:  -*%@@#*++*#@@%#=. ..    .#*....:-=+*#%%@@@@%#*=:....\n");
    wprintw(win, "::........:-#+:.::-#@@@%++#%%%#*#@@@#:    -@@@@+-: .:-=+*****+-:.     .:-=+++++=-:..::...::-+#%:.....::-+*#%%@@@@@@%#+-:\n");
    wprintw(win, "::...:=+##%%@@#-.. .*%@@@@+::..  +@@@%+=- =**++++=----------=====-:..       .-=+***#****+*#%%%=........::-=+*##%@@@@@@%#\n");
    wprintw(win, ":::-#@@%*=-::::-..:..:+@@@@+-:.  -*+=-::--==-:::::::--====+++**#####*=---===##@%%%%%@@%@@%%#=: ...........::--=+*#%%@@@@\n");
    wprintw(win, "::=@@@%:......   -@%-..+@%#*=-:...    -+=-::::--==+**++*###%#%%%%%%%@@@@%%@@@%%@#*+++==--:.   .... ...........::--=+*#%%\n");
    wprintw(win, "::=@@@@*-:....:-*@@@+..::.    ...   .**--==+++*******#@%@@@@==#-*@@%@@@@%%%@#**@@@%%##*+=-::.....:=:.............:::--=+\n");
    wprintw(win, "::.=#@@@@@%%%%@@%#=:... .+*+: ..  ..=@=+*****#####%%@@%:-+*#*+=-*%%%%%%##**#*=:-*%@@@@@%%##****###=...................::\n");
    wprintw(win, ":....:-=+**++=-:::---:.  :=:.      -%+%%**@@%%@@%%%%@@%*+=++**#%%%%##*+=====#*%. .:=+*##%%###*+=-. .....................\n");
    wprintw(win, ":........... :-===--=*#---====--:.  +#%%:.=+*#@%#********############%%%*+++**%=-==-::....... .:..=--...................\n");
    wprintw(win, ":...........=#==+++*###**++++*++++=- :%*%#**##*+=-*####%%%%%%%%%%%%@@@#+=+*#%@%##%#*+***+=-:...=+-+=+...................\n");
    wprintw(win, ":...........+#-*#@@+*+*#=-===*=+*=+++ =##%#**####*+#%%%%%%%%%%%%@@@@@@###%%%%@@@@@%####+=+*#**+:.. .....................\n");
    wprintw(win, ":...........:#*+*%@+++*++*++=--##=++*  +#*%%@%%%%%%###%%%%%%%@@@@@@%%%%%%%%%@@@%***##%%##****#%#+=-.....................\n");
    wprintw(win, ":..........*+-::::-=+**+**+*++*+++*#=-: :=+*#%%%%%%%%##%%%@@@%%%##%%%#####%@@%+-:::...:-+#%#+==*%%#*+-..................\n");
    wprintw(win, ":........:+%+++==-:--+*#%####**+===-=+#     .#%%%%%%%%%%%@@@%###%%#**##*#@@@@#+------:::--=*@%*=+#@%##*:................\n");
    wprintw(win, ":......:*+-:--==+******+#@%%#+-=+**+=:.   :==*#+*%%%#%%%%####%##*+*##*#@@#++*%%#+===------++##%%%##%%####:..............\n");
    wprintw(win, ":......-%==+==--+**#%#%%%+----=#*%.     .*+-:=%+**#%%#####%%#*+**%#*#@%*---=**#%@%%**++=--=+--=*###*#@@%*#..............\n");
    wprintw(win, ":.......-+*##%#**###***%#+==+**#+.      +#:-+%=++**+*++#%#****#%**#@%*-:::::=**#%@@#++=--::::--=*###%%@@#%+.............\n");
    wprintw(win, ":.........:=+*##*+==--=*%@%##*+#*:    :=*=-=#%+-+**##**-+%%##**#%@%+-:::::---=*#=#@@%**++====+++++++*****#%+:...........\n");
    wprintw(win, "::...........:-+#**######******++%=:-++-::--*@**=++****#######%@#+-:::----==+**#*#%@@@@%#%%******##########%#=..........\n");
    wprintw(win, "::..............=#%%%%%%####*****=:=#*++===+#@%+===+*##*##****%%*===+++++*****++####@@@@@@%###########*****+++..........\n");
    wprintw(win, ":::..............:+#%%%%%%%##*+=-::::##***#%@@@#+====+#######***#%#*+==--------=+**++#****==++++++.. :+##%%#. ..........\n");
    wprintw(win, ":::.................+#*%@@@%*+=-----*%-%###%@%%@@#*+++==+######*#%#**+=------=++:=+**##=   .=@@@#.... +@@%@@#=..........\n");
    wprintw(win, ":::::................:+#*#%@@@%#####*+*%*%@%@*%@@#+=-----=+++==--:.-+*#####***#%*::+%@@#-.  =@@@*....-%@%:=%@@%*........\n");
    wprintw(win, ":::::::::..............+#####%%%####%%%#%@%#- :+*=====+***#####*+: ..*@@@#...:#-::  :#@@@%-.#@@%-....#@@%#*##%@@#-......\n");
    wprintw(win, ":::::::::::.............:-+#%%%%#**++++++++++**#@=:-#@@@%-:.:=@@@@:. .%@@@%###%#. .:..:+%@@#%@@+ ...-@@@=:...:%@@@#+-:..\n");
    wprintw(win, ":::::::::::::.::...........::---..*%%###%@@@%-:-=*+ :%@@@+=+*%@@#-....:#@@@+...---*@=.. :*@@%%%+...-**+++-...:------::..\n");
    wprintw(win, ":::::::::::::::::::...............=@+:..:%@@@+:......=%@@@%=+#@@%#=::..-@@@@########*....--:::.:.....................:::\n");
    wprintw(win, ":::::::::::::::::::::..............:.....+%@@@*...... -@@@@=..:+%%%#*=:===---::.............................::::::::::::\n");
    wprintw(win, "::::::::::::::::::::::::::................-%@@@+::....-##**+=-..::......................................:..:::::::::::::\n");
    wprintw(win, "::::::::::::::::::::::::::::::............:#@%%#+=:...::.......................................:::::::::::::::::::::::::\n");
    wrefresh(win);
    napms(1500);
    wclear(win);
    wrefresh(win);
}

void print_welcome(WINDOW *win) {
  int y, x;
  getmaxyx(win, y, x);
  
  wclear(win);
  box(win, 0, 0);
  mvwprintw(win, y/2, (x-10)/2, "BEM-VINDO");
  wrefresh(win);
  napms(3000);
}

WINDOW *create_newwin(int height, int width, int starty, int startx) {
  WINDOW *local_win;

  local_win = newwin(height, width, starty, startx);
  box(local_win, 0, 0);
  wrefresh(local_win);
  return local_win;
}

void status_bar(WINDOW *status_win) {
  // Status bar
  mvwprintw(status_win, 0, 0, "ChicOS(S) | %s Press CTRL+C to quit", 
            app.debug ? "Debug Mode | " : "");
  wrefresh(status_win);
}

void render_loop(WINDOW *main_window, WINDOW *status_win) {
  status_bar(status_win);

  nodelay(main_window, TRUE);
  while (!app.loop_stop) {
    if (resized) {
      resized = 0;
      endwin();
      refresh();

      delwin(main_window);
      main_window = create_newwin(LINES-1, COLS, 1, 0);
    }
    wclear(main_window);
    box(main_window, 0, 0);  
    wprintw(main_window, "free mem: %2.2f%%", retrieve_free_mem_percentage());
    wprintw(main_window, "used mem: %2.2f%%", retrieve_used_mem_percentage());
    wprintw(main_window, "quantum time: %ld", app.cpu.quantum_time);
    wprintw(main_window, "Terminal: %dx%d", COLS, LINES);
    wrefresh(main_window);
    napms(100);
  }
}


void *init_render(void *arg) {
  initscr();
  cbreak();
  noecho();
  curs_set(0);

  if (!app.debug) {
    WINDOW *logo_window = create_newwin(LINES, COLS, 0, 0);
    print_logo(logo_window);
    print_welcome(logo_window);
    wclear(logo_window);
    wrefresh(logo_window);
    delwin(logo_window);
  }

  WINDOW *status_win = create_newwin(1, COLS, 0, 0);
  WINDOW *main_win = create_newwin((LINES/2)-1, COLS, 1, 0);

  render_loop(main_win, status_win);

  delwin(status_win);
  delwin(main_win);
  endwin();
  return NULL;
}
